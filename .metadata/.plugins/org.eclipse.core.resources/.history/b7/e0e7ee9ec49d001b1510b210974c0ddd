/*
 * spi.c
 *
 *  Created on: Apr 15, 2021
 *      Author: mined
 */


#include "spi.h"

uint8_t addChip(SPI_HandleTypeDef* hspix, GPIO_TypeDef* GPIO_port, uint16_t GPIO_num){
	uint8_t chip_num = 0;
	uint8_t index = 0;

	for(; index < 255; index++){
		if(chip_list[index].CS_pin == 0){
			chip_num = index;
			break;
		}
	}

	if(index != 255){
		chip_list[index].hspi = hspix;
		chip_list[index].CS_port = GPIO_port;
		chip_list[index].CS_pin = GPIO_num;
		HAL_GPIO_WritePin(chip_list[chip_num].CS_port, chip_list[chip_num].CS_pin, GPIO_PIN_SET);

		return 0;
	}else{
		return -1;
	}
}

void deletechip(uint16_t chip_num){
	chip_list[chip_num].hspi = 0;
	chip_list[chip_num].CS_port = 0;
	chip_list[chip_num].CS_pin = 0;
}

uint16_t read2ByteRegister(uint8_t chip_num){
	uint16_t read_data = 0;

	HAL_GPIO_WritePin(chip_list[chip_num].CS_port, chip_list[chip_num].CS_pin, GPIO_PIN_RESET);

	HAL_StatusTypeDef state = HAL_SPI_Receive(chip_list[chip_num].hspi, (uint8_t*)&read_data, 1, HAL_MAX_DELAY);

	HAL_GPIO_WritePin(chip_list[chip_num].CS_port, chip_list[chip_num].CS_pin, GPIO_PIN_SET);

	if(state != HAL_OK){
		return -1;
	}

	return read_data;
}

HAL_StatusTypeDef wriet2ByteRegister(uint16_t* command, uint8_t chip_num){

	HAL_GPIO_WritePin(chip_list[chip_num].CS_port, chip_list[chip_num].CS_pin, GPIO_PIN_RESET);

	HAL_StatusTypeDef state = HAL_SPI_Transmit(chip_list[chip_num].hspi, uint8_t *pData, uint16_t Size, uint32_t Timeout);

	HAL_GPIO_WritePin(chip_list[chip_num].CS_port, chip_list[chip_num].CS_pin, GPIO_PIN_SET);
}
